<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Board">

	<select id="getTotalAllCount" parameterType="map" resultType="int">
	    SELECT COUNT(*)
	    FROM board
	    WHERE 1=1
	    <if test="isAdmin == false">
	        AND is_privated <![CDATA[ <= ]]> #{is_privated}
	    </if>
	</select>

	<select id="getTotalAllFindTargetCount" parameterType="map" resultType="int">
		SELECT COUNT(*)
    	FROM board
    	WHERE (
        	title   LIKE concat('%', #{target}, '%')
        	OR content LIKE concat('%', #{target}, '%')
    	)
      	AND is_privated <![CDATA[ <= ]]> #{is_privated}
	</select>

	<select id="getTotalTypeCount" resultType="int">
		select count(*) 
		from board 
		where board_type=#{board_type} and is_privated <![CDATA[ <= ]]> #{is_privated}
	</select>

	<select id="getTotalTypeFindTargetCount" resultType="int">
		select count(*) 
		from board 
		where board_type=#{board_type}
		and is_privated <![CDATA[ <= ]]> #{is_privated}
		and (
			title like concat('%', #{target}, '%') 
			or content like concat('%', #{target}, '%')
		)
	</select>

	<select id="getBoardListFromTo" resultType="com.kedu.project.board.BoardDTO">
		select * from board
		<where>
			<if test="board_type != null and board_type != '' and board_type != 'all'">
				board_type = #{board_type}
			</if>
			<if test="is_privated != null">
			    and is_privated <![CDATA[ <= ]]> #{is_privated}
			</if>
		</where>
		order by board_seq desc
		limit #{offset}, #{count}
	</select>

	<select id="getBoardListFromToWithTarget" resultType="com.kedu.project.board.BoardDTO">
		select * from board
		<where>
			<if test="target != null and target != ''">
				(title like concat('%', #{target}, '%') 
				or content like concat('%', #{target}, '%'))
			</if>
			<if test="board_type != null and board_type != '' and board_type != 'all'">
			    and board_type = #{board_type}
			</if>
			<if test="is_privated != null">
			    and is_privated <![CDATA[ <= ]]> #{is_privated}
			</if>
		</where>
		order by board_seq desc
		limit #{offset}, #{count}
	</select>
	
	<insert id="postBoard" parameterType="com.kedu.project.board.BoardDTO" useGeneratedKeys="true" keyProperty="board_seq">
	    insert into board (user_id, board_type, content, title, is_privated, created_at)
	    values (#{user_id}, #{board_type}, #{content}, #{title}, #{is_privated}, now())
	</insert>

	<select id="getDetailBoard" parameterType="map" resultType="map">
	    select
	        b.board_seq,
	        b.board_type,
	        b.user_id,
	        b.title,
	        b.content,
	        b.is_reported,
	        b.is_privated,
	        b.view_count,
	        b.created_at,
	        u.nickname
	    from board b
	    join user u on b.user_id = u.user_id
	    where b.board_seq = #{board_seq}
	</select>
	
	<delete id="deleteTargetBoard">
		delete from board where board_seq = #{board_seq} and user_id= #{user_id}
	</delete>
	
	<update id="updateBoard">
		update board set title=#{title}, content = #{content}, board_type = #{board_type}, is_privated = #{is_privated} where board_seq = #{board_seq} and user_id= #{user_id}
	</update>
	
	<update id="increaseViewCount">
		update board set view_count = view_count +1
		where board_seq = #{board_seq}
	</update>
	
	<update id="updateCommentCount">
	    UPDATE board
	    SET is_reported = (
	        SELECT COUNT(*)
	        FROM comment
	        WHERE board_seq = #{board_seq}
	          AND is_deleted = 0
	    )
	    WHERE board_seq = #{board_seq};
	</update>
	
	<select id="getBoardWriterId" resultType="String">
		select user_id from board where board_seq = #{board_seq}
	</select>

	<delete id="admindeleteBoard">
		delete from board where board_seq = #{board_seq}
	</delete>

</mapper>
